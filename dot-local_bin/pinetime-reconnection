#!/bin/bash

MAX_FAST_RETRIES=60

trap "stty echo" EXIT

RETRY_COUNT=0
TEMP_FILE="/tmp/notifications-delayed.txt"
MONITOR_PID=""
PINETIME_MAC=""

echo "Attempting PineTime autodiscovery..."
while true; do
  PINETIME_MAC=$(bluetoothctl devices Connected | cut -d ' ' -f 2 | while read -r MAC; do
    if bluetoothctl info "$MAC" | grep -q "Name: InfiniTime"; then
      echo "$MAC"
      break
    fi
  done)

  if [ -z "$PINETIME_MAC" ]; then
    PINETIME_MAC=$(bluetoothctl devices | cut -d ' ' -f 2 | while read -r MAC; do
      if bluetoothctl info "$MAC" | grep -q "Name: InfiniTime"; then
        echo "$MAC"
        break
      fi
    done)
  fi

  if [ -n "$PINETIME_MAC" ]; then
    echo "  PineTime found at $PINETIME_MAC."
    break
  fi

  echo "  PineTime connection not detected. Retrying in 2 minutes."
  sleep 120
done

stop_monitor() {
  if [ -n "$MONITOR_PID" ]; then
    kill "$MONITOR_PID" 2>/dev/null
    wait "$MONITOR_PID" 2>/dev/null
    MONITOR_PID=""
  fi
  > "$TEMP_FILE"
}

start_monitor() {
  stop_monitor
  dbus-monitor "interface='org.freedesktop.Notifications',member='Notify'" | while read -r LINE; do
    if [[ "$LINE" == *"string"* ]]; then
      MESSAGE=$(echo "$LINE" | grep -oP '(?<=string ").*?(?=")' | tail -n1)
      echo "$MESSAGE" >> "$TEMP_FILE"
    fi
  done &
  MONITOR_PID=$!
}

send_queued_notifications() {
  if [ -s "$TEMP_FILE" ]; then
    while IFS= read -r LINE; do
      notify-send --urgency=low --expire-time=50 --transient "$LINE"
      sleep 0.5
    done < "$TEMP_FILE"
    > "$TEMP_FILE"
  fi
}

attempt_reconnect() {
  if bluetoothctl show | grep -q "Powered: yes"; then
    if ! bluetoothctl info "$PINETIME_MAC" | grep -q "Connected: yes"; then
      echo "    Attempting reconnection to $PINETIME_MAC."
      bluetoothctl connect "$PINETIME_MAC" > /dev/null 2>&1
      sleep 5
      if bluetoothctl info "$PINETIME_MAC" | grep -q "Connected: yes"; then
        echo "      Reconnection successful. Restarting WatchMate."
        stop_monitor
        killall -q watchmate
        flatpak run io.gitlab.azymohliad.WatchMate --gapplication-service > /dev/null 2>&1 &
        sleep 2
        send_queued_notifications
        RETRY_COUNT=0
        return 0
      else
        echo "      Reconnection unsuccessful."
        return 1
      fi
    else
      echo "    Device already connected."
      stop_monitor
      RETRY_COUNT=0
      return 0
    fi
  else
    echo "    Bluetooth is powered off. Standing by."
  fi
  return 1
}

echo "Monitoring started for $PINETIME_MAC"

stdbuf -oL bluetoothctl | while read -r LINE; do
  if echo "$LINE" | grep -q "Device $PINETIME_MAC Connected: no"; then
    echo "  Disconnection detected!"
    start_monitor
    RETRY_COUNT=0

    while [ $RETRY_COUNT -lt $MAX_FAST_RETRIES ]; do
      echo "  Quick reconnection attempt $((RETRY_COUNT+1))/$MAX_FAST_RETRIES..."
      attempt_reconnect && break
      ((RETRY_COUNT++))
    done

    if [ $RETRY_COUNT -ge $MAX_FAST_RETRIES ]; then
      echo "  Watch not found. Decreasing reconnection attempt frequency."
      stop_monitor
      while true; do
        sleep 120
        attempt_reconnect && break
      done
    fi
  fi
done
